---
title: "Seer Proteograph Comparison: Gen1 (5NP) vs. XT (2NP)"
author: "Sophia Soriano"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(readr)
library(readxl)
library(SomaDataIO)
library(stringr)
library(EnvStats)
library(plotly)
library(htmlwidgets)
library(ggrepel)
library(truncnorm)
library(scales)
library(knitr)
library(naniar)
library(eList)
library(stats)
library(toolbox)
library(arsenal)
library(multcompView)
library(viridis)
library(car)
library(nortest)
library(ggVennDiagram)
library(VennDiagram)
```

```{r MUS_Load_Data}
#Load murine raw data
raw_data_murine = read.delim("~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/Murine_dilution/report.tsv")
```

### Murine Sample Volume Experiment

```{r MUS_Organize_Data}
#Code from Matt for DIANN raw data processing
diann_MUS_subset = raw_data_murine %>%
                      #Filter out peptides with Precursor and Protein Group intensities of 0
                      filter(Precursor.Quantity > 0) %>%
                      filter(PG.Quantity > 0) %>%
                      #Filter our any peptides & protein groups that have a Q value of > 0.01 (FDR 1%)
                      filter(Global.PG.Q.Value < 0.01) %>%
                      filter(Global.Q.Value < 0.01) %>%
                      filter(Q.Value < 0.01)

#Make new Sample, NP, replicate columns in data df with grep/substring
diann_MUS_subset = diann_MUS_subset %>% mutate(Sample = sub("[0-9]*_(.*)([A-Z])_NP.*","\\1_\\2",Run),
                                               NP = sub("[0-9]*_.*_NP(.).*","\\1",Run),
                                               Volume = sub(".*_(.*)uL_.*","\\1",Sample),
                                               Volume = ifelse(grepl("neat",Sample),250,Volume),
                                               Volume = suppressWarnings(as.numeric(Volume)),
                                               Replicate = sub(".*(.)$","\\1",Sample))

#Convert output to summarized protein info by removing duplicate peptides
MUS_proteins = diann_MUS_subset %>%
                group_by(Run, Protein.Group, PG.Quantity, PG.Normalised, PG.MaxLFQ, PG.Q.Value) %>%
                distinct(Run, Protein.Group, PG.Quantity, PG.Normalised, PG.MaxLFQ, PG.Q.Value, .keep_all = TRUE) %>%
                ungroup() %>%
                mutate(Log2_LFQ_Intensity = ifelse(PG.MaxLFQ == 0, NA, log2(PG.MaxLFQ))) %>%
                #filter(!is.na(Log2_LFQ_Intensity)) %>%
                mutate(Log2_Raw_Intensity = ifelse(PG.Quantity == 0, NA, log2(PG.Quantity))) %>%
                filter(!is.na(Log2_Raw_Intensity))

#Save protein data table - no sparsity filter
write.table(MUS_proteins, "~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/Murine_dilution/SeerXT_MUS_proteins.tsv", sep = "\t", row.names = FALSE)
```

```{r MUS_Sparsity_Filter}
#Calculate number of replicated per volume
num_MUS_rep = n_distinct(MUS_proteins$Sample)/n_distinct(MUS_proteins$Volume)

#50% Sparsity Filter - by volume
# seerXT_MUS_final_df = MUS_proteins %>%
#   mutate(Feature = paste(NP, Protein.Ids, sep = "_")) %>%
#   group_by(Feature,Volume) %>%
#   mutate(percent_detection = n_distinct(Sample)/num_MUS_rep) %>%
#   ungroup() %>%
#   filter(percent_detection >= 0.5)

#3RepMin Sparsity Filter - by volume - feature appears in all 3 replicates
seerXT_MUS_final_3Rep_df = MUS_proteins %>%
  mutate(Feature = paste(NP, Protein.Ids, sep = "_")) %>%
  group_by(Feature,Volume) %>%
  mutate(detection_repcount = n_distinct(Sample)) %>%
  ungroup() %>%
  filter(detection_repcount == 3)

#2RepMin Sparsity Filter - by volume - feature appears in >=2 replicates (use for analytics going forward)
seerXT_MUS_final_2Rep_df = MUS_proteins %>%
  mutate(Feature = paste(NP, Protein.Ids, sep = "_")) %>%
  group_by(Feature,Volume) %>%
  mutate(detection_repcount = n_distinct(Sample)) %>%
  ungroup() %>%
  filter(detection_repcount >= 2)

#No Sparsity Filter - by volume - no filter
seerXT_MUS_final_1Rep_df = MUS_proteins %>%
  mutate(Feature = paste(NP, Protein.Ids, sep = "_")) %>%
  group_by(Feature,Volume) %>%
  mutate(detection_repcount = n_distinct(Sample)) %>%
  ungroup() %>%
  filter(detection_repcount >= 1)

#Save data after 50% sparsity filter
write.table(seerXT_MUS_final_2Rep_df, "~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/Murine_dilution/SeerXT_MUS_proteins_50SF.tsv", sep = "\t", row.names = FALSE)
```

```{r MUS_DataTransform}
#Transform data to wide form for statistical test
seerXT_MUS_wide_df = seerXT_MUS_final_2Rep_df %>% mutate(Volume_uL = paste(Volume,"uL",sep="")) %>%
                                                dplyr::group_by(Feature,Protein.Ids,Volume_uL) %>%
                                                summarize(data = list(Log2_Raw_Intensity), count = n(), .groups = "drop") %>%
                                                pivot_wider(names_from = Volume_uL, values_from = c(data,count))

#Filter out any features with <1 intensity count
seerXT_MUS_wide_allV_df = seerXT_MUS_wide_df %>% filter(count_10uL>=1 & count_25uL>=1 & count_50uL>=1 & 
                                                          count_100uL>=1 & count_125uL>=1 & count_250uL>=1)

```

**Table 1: Feature counts for murine samples in volume experiment. PG.Quantity (raw) data used.**

```{r MUS_Feature_Num_Table}
#Create df for feature count table
MUS_featnum_noSF_df = seerXT_MUS_final_1Rep_df %>% dplyr::group_by(Sample,Volume) %>%
                                                    summarise(Feature_Count_noSF = n())

MUS_featnum_2Rep_df = seerXT_MUS_final_2Rep_df %>% dplyr::group_by(Sample) %>%
                                                    summarise(Feature_Count_2RepMin = n())

MUS_featnum_df = merge(MUS_featnum_noSF_df,MUS_featnum_2Rep_df, by = "Sample")
# Add other sparsity filter data to table
MUS_featnum_3Rep_df = seerXT_MUS_final_3Rep_df %>% dplyr::group_by(Sample) %>%
                                              summarise(Feature_Count_3RepMin = n())
MUS_featnum_df = merge(MUS_featnum_df,MUS_featnum_3Rep_df,by = "Sample")
MUS_featnum_df["Feature_Count_1RepMin_AllVolumes"] = length(seerXT_MUS_wide_allV_df$Feature)

MUS_feattable_df = MUS_featnum_df %>% arrange(Volume) %>% dplyr::select(-Volume)
knitr::kable(MUS_feattable_df)
```

```{r MUS_Feature_Count_Plot, include=FALSE}

MUS_featnum_plot_df = MUS_featnum_df %>% group_by(Volume) %>%
                                          mutate(Mean_Feature_Count_noSF = round(mean(Feature_Count_noSF),0),
                                                 Mean_Feature_Count_2RepMin = round(mean(Feature_Count_2RepMin),0),
                                                 Mean_Feature_Count_3RepMin = round(mean(Feature_Count_3RepMin),0)) %>%
                                          ungroup() %>%
                                          dplyr::select(c("Volume","Mean_Feature_Count_noSF",
                                                          "Mean_Feature_Count_2RepMin","Mean_Feature_Count_3RepMin")) %>%
                                          unique() %>%
                                          pivot_longer(names_to = c("FilterType"),
                                                       values_to = c("Mean_Feature_Count"),
                                                       cols = starts_with("Mean")) %>%
                                          mutate(FilterType = sub("Mean_Feature_Count_","",FilterType))

#Bar plot
MUS_featnum_plot = ggplot(MUS_featnum_plot_df, aes(fill=FilterType, y=Mean_Feature_Count, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "nudge",stat="identity") + 
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Feature Count",
       title = "Seer Proteograph XT Comparison: Murine Feature Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_featnum_plot.png")
MUS_featnum_plot

# \newline
# 
# **Figure X: Feature counts for murine samples across volume conditions. Colors represent different sparsity filters applied at the feature level across replicates for a sample (no filter, 2 replicate minimum, 3 replicate minimum).**
```

```{r MUS_Feature_Count_Plot2, include=FALSE}
#Plot noSF protein data similar to peptide bar graph below
MUS_featnum_plot2_df = MUS_featnum_noSF_df %>% group_by(Volume) %>%
                                        mutate(Mean_Feature_Count_noSF = round(mean(Feature_Count_noSF),0),
                                               SD_Feature_Count_noSF = sd(Feature_Count_noSF)) %>%
                                        ungroup() %>%
                                        mutate(Replicate = sub(".*(.)$","\\1",Sample))

#Bar plot
MUS_featnum_plot2 = ggplot(MUS_featnum_plot2_df,
                          aes(fill=Replicate, y=Feature_Count_noSF, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "dodge",stat="identity") + 
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Feature Count",
       title = "Seer Proteograph XT Comparison: Murine Feature Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_featnum_plot2.png")
MUS_featnum_plot2

# \newline
# 
# **Figure X: Feature counts for murine samples across volume conditions. Colors represent different replicates (A, B, C) for each volume. No sparsity filter is applied.**
```


```{r MUS_Feature_Count_Plot3}
#Plot noSF protein data similar to peptide bar graph below
MUS_featnum_plot3_df = MUS_featnum_df %>% group_by(Volume) %>%
                                           summarise(Mean_Feature_Count_noSF = round(mean(Feature_Count_noSF),0),
                                                  SD_Feature_Count_noSF = sd(Feature_Count_noSF),
                                                  Mean_Feature_Count_2RepMin = round(mean(Feature_Count_2RepMin),0),
                                                  SD_Feature_Count_2RepMin = sd(Feature_Count_2RepMin),
                                                  Mean_Feature_Count_3RepMin = round(mean(Feature_Count_3RepMin),0),
                                                  SD_Feature_Count_3RepMin = sd(Feature_Count_3RepMin)) %>%
                                          pivot_longer(names_to = c(".value","FilterType"),
                                                       names_sep = c("_Feature_Count_"),
                                                       -c("Volume")) %>%
                                          mutate(FilterType = ifelse(FilterType == "noSF",
                                                                      "1RepMin (no filter)",
                                                                      FilterType))
                                                                        

#Bar plot
MUS_featnum_plot3 = ggplot(MUS_featnum_plot3_df,
                          aes(fill=FilterType, y=Mean, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "dodge",stat="identity", alpha = 0.85) + 
  geom_errorbar(aes(ymin=Mean-SD, ymax=Mean+SD), position = position_dodge(0.9), stat = "identity",colour="black", alpha=0.8, size=0.5, width = 0.4) +
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Feature Count",
       title = "Seer Proteograph XT Comparison: Murine Feature Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_featnum_plot3.png")
MUS_featnum_plot3
```

\newline

**Figure 1: Feature counts for murine samples across volume conditions. Colors represent different sparsity filters (no filter, 2 replicate minimum, 3 replicate minimum). Error bars represent +/- 1 SD from the mean, calculated across replicates. PG.Quantity (raw) data used. Sample volumes 100-250µL have the highest feature counts.**

\newline

**Table 2: Protein counts for murine samples in volume experiment. PG.Quantity (raw) data used.**

```{r MUS_Protein_Num_Table}
#Create df for protein count table
MUS_protnum_noSF_df = seerXT_MUS_final_1Rep_df %>% dplyr::select(c("Sample","Volume","Protein.Ids")) %>%
                                                   unique() %>%
                                                   dplyr::group_by(Sample,Volume) %>%
                                                   summarise(Protein_Count_noSF = n())

MUS_protnum_2Rep_df = seerXT_MUS_final_2Rep_df %>% dplyr::select(c("Sample","Volume","Protein.Ids")) %>%
                                                   unique() %>%
                                                   dplyr::group_by(Sample) %>%
                                                   summarise(Protein_Count_2RepMin = n())

MUS_protnum_df = merge(MUS_protnum_noSF_df,MUS_protnum_2Rep_df, by = "Sample")
# Add other sparsity filter data to table
MUS_protnum_3Rep_df = seerXT_MUS_final_3Rep_df %>% dplyr::select(c("Sample","Volume","Protein.Ids")) %>%
                                                   unique() %>%
                                                   dplyr::group_by(Sample) %>%
                                                   summarise(Protein_Count_3RepMin = n())
MUS_protnum_df = merge(MUS_protnum_df,MUS_protnum_3Rep_df,by = "Sample")
MUS_protnum_df["Protein_Count_1RepMin_AllVolumes"] = length(unique(seerXT_MUS_wide_allV_df$Protein.Ids))

MUS_prottable_df = MUS_protnum_df %>% arrange(Volume) %>% dplyr::select(-Volume)
knitr::kable(MUS_prottable_df)
```

```{r MUS_Protein_Count_Plot, include=FALSE}

MUS_protnum_plot_df = MUS_protnum_df %>% group_by(Volume) %>%
                                          mutate(Mean_Protein_Count_noSF = round(mean(Protein_Count_noSF),0),
                                                 Mean_Protein_Count_2RepMin = round(mean(Protein_Count_2RepMin),0),
                                                 Mean_Protein_Count_3RepMin = round(mean(Protein_Count_3RepMin),0)) %>%
                                          ungroup() %>%
                                          dplyr::select(c("Volume","Mean_Protein_Count_noSF",
                                                          "Mean_Protein_Count_2RepMin","Mean_Protein_Count_3RepMin")) %>%
                                          unique() %>%
                                          pivot_longer(names_to = c("FilterType"),
                                                       values_to = c("Mean_Protein_Count"),
                                                       cols = starts_with("Mean")) %>%
                                          mutate(FilterType = sub("Mean_Protein_Count_","",FilterType))

#Bar plot
MUS_protnum_plot = ggplot(MUS_protnum_plot_df, aes(fill=FilterType, y=Mean_Protein_Count, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "nudge",stat="identity") + 
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Protein Count",
       title = "Seer Proteograph XT Comparison: Murine Protein Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_protnum_plot.png")
MUS_protnum_plot

# \newline
# 
# **Figure X: Protein counts for murine samples across volume conditions. Colors represent different sparsity filters applied at the feature level across replicates for a sample (no filter, 2 replicate minimum, 3 replicate minimum).**
```

```{r MUS_Protein_Count_Plot2, include=FALSE}
#Plot noSF protein data similar to peptide bar graph below
MUS_protnum_plot2_df = MUS_protnum_noSF_df %>% group_by(Volume) %>%
                                        mutate(Mean_Protein_Count_noSF = round(mean(Protein_Count_noSF),0),
                                               SD_Protein_Count_noSF = sd(Protein_Count_noSF)) %>%
                                        ungroup() %>%
                                        mutate(Replicate = sub(".*(.)$","\\1",Sample))

#Bar plot
MUS_protnum_plot2 = ggplot(MUS_protnum_plot2_df,
                          aes(fill=Replicate, y=Protein_Count_noSF, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "dodge",stat="identity") + 
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Protein Count",
       title = "Seer Proteograph XT Comparison: Murine Protein Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_protnum_plot2.png")
MUS_protnum_plot2

# \newline
# 
# **Figure X: Protein counts for murine samples across volume conditions. Colors represent different replicates (A, B, C) for each volume. No sparsity filter is applied.**
```

```{r MUS_Protein_Count_Plot3}
#Plot noSF protein data similar to peptide bar graph below
MUS_protnum_plot3_df = MUS_protnum_df %>% group_by(Volume) %>%
                                           summarise(Mean_Protein_Count_noSF = round(mean(Protein_Count_noSF),0),
                                                  SD_Protein_Count_noSF = sd(Protein_Count_noSF),
                                                  Mean_Protein_Count_2RepMin = round(mean(Protein_Count_2RepMin),0),
                                                  SD_Protein_Count_2RepMin = sd(Protein_Count_2RepMin),
                                                  Mean_Protein_Count_3RepMin = round(mean(Protein_Count_3RepMin),0),
                                                  SD_Protein_Count_3RepMin = sd(Protein_Count_3RepMin)) %>%
                                          pivot_longer(names_to = c(".value","FilterType"),
                                                       names_sep = c("_Protein_Count_"),
                                                       -c("Volume")) %>%
                                          mutate(FilterType = ifelse(FilterType == "noSF",
                                                                      "1RepMin (no filter)",
                                                                      FilterType))
                                                                        
#Bar plot
MUS_protnum_plot3 = ggplot(MUS_protnum_plot3_df,
                          aes(fill=FilterType, y=Mean, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "dodge",stat="identity", alpha = 0.85) + 
  geom_errorbar(aes(ymin=Mean-SD, ymax=Mean+SD), position = position_dodge(0.9), stat = "identity",colour="black", size=0.5, width = 0.4) +
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Protein Count",
       title = "Seer Proteograph XT Comparison: Murine Protein Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_protnum_plot3.png")
MUS_protnum_plot3
```

\newline

**Figure 2: Protein counts for murine samples across volume conditions. Colors represent different sparsity filters (no filter, 2 replicate minimum, 3 replicate minimum). Error bars represent +/- 1 SD from the mean, calculated across replicates. PG.Quantity (raw) data used. Sample volumes 100-250µL have the highest protein counts.**

\newline

**Table 3: Peptide counts for murine samples in volume experiment. PG.Quantity (raw) data used.**

```{r MUS_Peptide_Num_Table}
#Create df for peptide count table
MUS_peptide_df = diann_MUS_subset %>% 
                  mutate(Log2_LFQ_Intensity = ifelse(PG.MaxLFQ == 0, NA, log2(PG.MaxLFQ))) %>%
                  mutate(Log2_Raw_Intensity = ifelse(PG.Quantity == 0, NA, log2(PG.Quantity))) %>%
                  #filter(!is.na(Log2_LFQ_Intensity)) %>%
                  filter(!is.na(Log2_Raw_Intensity))

#No Sparsity Filter
MUS_peptide_1Rep_df = MUS_peptide_df  %>%
  mutate(Protein_Peptide = paste(Protein.Ids, Precursor.Id, sep = "_")) %>%
  group_by(Protein_Peptide,Volume) %>%
  mutate(detection_repcount = n_distinct(Sample)) %>%
  ungroup() %>%
  filter(detection_repcount >= 1)

#3RepMin Sparsity Filter - by volume - feature appears in all 3 replicates
MUS_peptide_3Rep_df = MUS_peptide_df  %>%
  mutate(Protein_Peptide = paste(Protein.Ids, Precursor.Id, sep = "_")) %>%
  group_by(Protein_Peptide,Volume) %>%
  mutate(detection_repcount = n_distinct(Sample)) %>%
  ungroup() %>%
  filter(detection_repcount == 3)

#2RepMin Sparsity Filter - by volume - feature appears in >=2 replicates (use for analytics going forward)
MUS_peptide_2Rep_df = MUS_peptide_df  %>%
  mutate(Protein_Peptide = paste(Protein.Ids, Precursor.Id, sep = "_")) %>%
  group_by(Protein_Peptide,Volume) %>%
  mutate(detection_repcount = n_distinct(Sample)) %>%
  ungroup() %>%
  filter(detection_repcount >= 2)

#Create df for peptide count table
MUS_pepnum_noSF_df = MUS_peptide_1Rep_df %>% dplyr::select(c("Sample","Volume","Protein.Ids","Precursor.Id")) %>%
                                             unique() %>%
                                             dplyr::group_by(Sample,Volume) %>%
                                             summarise(Peptide_Count_noSF = n())

MUS_pepnum_2Rep_df = MUS_peptide_2Rep_df %>% dplyr::select(c("Sample","Volume","Protein.Ids","Precursor.Id")) %>%
                                             unique() %>%
                                             dplyr::group_by(Sample) %>%
                                             summarise(Peptide_Count_2RepMin = n())

MUS_pepnum_df = merge(MUS_pepnum_noSF_df,MUS_pepnum_2Rep_df, by = "Sample")
# Add other sparsity filter data to table
MUS_pepnum_3Rep_df = MUS_peptide_3Rep_df %>% dplyr::select(c("Sample","Volume","Protein.Ids","Precursor.Id")) %>%
                                             unique() %>%
                                             dplyr::group_by(Sample) %>%
                                             summarise(Peptide_Count_3RepMin = n())

MUS_pepnum_df = merge(MUS_pepnum_df,MUS_pepnum_3Rep_df,by = "Sample")

MUS_peptable_df = MUS_pepnum_df %>% arrange(Volume) %>% dplyr::select(-Volume)
knitr::kable(MUS_peptable_df)
```

```{r MUS_Peptide_Count_Plot, include=FALSE}
#Create df for peptide count plot
MUS_pepnum_plot_df = MUS_pepnum_df %>% group_by(Volume) %>%
                                        mutate(Mean_Peptide_Count_noSF = round(mean(Peptide_Count_noSF),0),
                                               SD_Peptide_Count_noSF = sd(Peptide_Count_noSF)) %>%
                                        ungroup() %>%
                                        mutate(Replicate = sub(".*(.)$","\\1",Sample))

#Bar plot
MUS_pepnum_plot = ggplot(MUS_pepnum_plot_df, aes(fill=Replicate, y=Peptide_Count_noSF, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "dodge",stat="identity") + 
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Peptide Count",
       title = "Seer Proteograph XT Comparison: Murine Peptide Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_pepnum_plot.png")
MUS_pepnum_plot
```
\newline

**Figure 3: Peptide counts for murine samples across volume conditions. Colors represent different replicates (A, B, C) for each volume. No sparsity filter is applied. PG.Quantity (raw) data used.**

```{r MUS_Peptide_Count_Plot3}
#Plot noSF protein data similar to peptide bar graph below
MUS_pepnum_plot2_df = MUS_pepnum_df %>% group_by(Volume) %>%
                                          summarise(Mean_Peptide_Count_noSF = round(mean(Peptide_Count_noSF),0),
                                                    SD_Peptide_Count_noSF = sd(Peptide_Count_noSF),
                                                    Mean_Peptide_Count_2RepMin = round(mean(Peptide_Count_2RepMin),0),
                                                    SD_Peptide_Count_2RepMin = sd(Peptide_Count_2RepMin),
                                                    Mean_Peptide_Count_3RepMin = round(mean(Peptide_Count_3RepMin),0),
                                                    SD_Peptide_Count_3RepMin = sd(Peptide_Count_3RepMin)) %>%
                                          pivot_longer(names_to = c(".value","FilterType"),
                                                       names_sep = c("_Peptide_Count_"),
                                                       -c("Volume")) %>%
                                          mutate(FilterType = ifelse(FilterType == "noSF",
                                                                      "1RepMin (no filter)",
                                                                      FilterType))
                                                                        
#Bar plot
MUS_pepnum_plot2 = ggplot(MUS_pepnum_plot2_df,
                          aes(fill=FilterType, y=Mean, x=reorder(as.factor(Volume),Volume))) + 
  geom_bar(position = "dodge",stat="identity", alpha = 0.85) + 
  geom_errorbar(aes(ymin=Mean-SD, ymax=Mean+SD), position = position_dodge(0.9), stat = "identity",colour="black", size=0.5, width = 0.4) +
  theme_bw() +
  labs(x = "Volume (uL)",
       y = "Mean Peptide Count",
       title = "Seer Proteograph XT Comparison: Murine Peptide Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/MUS_pepnum_plot2.png")
MUS_pepnum_plot2
```

\newline

**Figure 4: Peptide counts for murine samples across volume conditions. Colors represent different sparsity filters (no filter, 2 replicate minimum, 3 replicate minimum). Error bars represent +/- 1 SD from the mean, calculated across replicates. PG.Quantity (raw) data used. Sample volumes 100-250µL have the highest peptide counts.**

```{r MUS_ANOVA_P1, include = FALSE}
#Transform data for anova
seerXT_MUS_anova_df = seerXT_MUS_final_2Rep_df %>% mutate(Volume_uL = paste(Volume,"uL",sep="")) %>%
                                                dplyr::group_by(Feature,Volume_uL,Volume) %>%
                                                summarize(Mean_Log2_LFQ_Intensity = mean(Log2_LFQ_Intensity),
                                                          Mean_Log2_Raw_Intensity = mean(Log2_Raw_Intensity),
                                                          count = n(), .groups = "drop")

#Create function to generate labels from tukey results
generate_label_df <- function(TUKEY, variable){
  # Extract labels and factor levels from Tukey post-hoc 
  Tukey.levels = TUKEY[[variable]][,4]
  Tukey.labels = data.frame(multcompLetters(Tukey.levels)['Letters'])

  #I need to put the labels in the same order as in the boxplot :
  Tukey.labels$treatment=rownames(Tukey.labels)
  Tukey.labels=Tukey.labels[order(Tukey.labels$treatment) , ]
  return(Tukey.labels)
}

#Create linear model for aov() - (yValue ~ xValue)
model = lm(Mean_Log2_Raw_Intensity ~ Volume_uL, data = seerXT_MUS_anova_df)
MUS_anova = aov(model)

#ANOVA Assumptions
# 1. Homogeneity of variances - plot and Levene’s test
plot(MUS_anova, 1)
leveneTest(Mean_Log2_Raw_Intensity ~ Volume_uL, data = seerXT_MUS_anova_df)
lt_pval = leveneTest(Mean_Log2_Raw_Intensity ~ Volume_uL, data = seerXT_MUS_anova_df)$`Pr(>F)`[1]
# 2. Normality - plot and Shapiro-Wilk or Anderson-Darling test
plot(MUS_anova, 2)
MUS_anova_residuals = residuals(object = MUS_anova)
#shapiro.test(x = MUS_anova_residuals) - sample size too large for this
ad.test(MUS_anova_residuals)
ad_pval = ad.test(MUS_anova_residuals)$p.value


# \newline
# 
# **Figure X: Plots and tests assessing the validity of the ANOVA test assumptions. Homogeneity of variances assumption is valid given absence of outliers on first plot and Levene's test p-value `r round(lt_pval,2)` > $\alpha$ = 0.05. Normality assumption is acceptable given a relatively normal line on the normality plot and knowing that a log2 transformation has already been applied to this data, despite Anderson-Darling test resulting in p-value < `r round(ad_pval,4)`. PG.Quantity (raw) data used.**
```

```{r MUS_ANOVA_P2}
# Tukey test to study each pair of treatment :
MUS_tukey = TukeyHSD(MUS_anova, which = "Volume_uL", conf.level = 0.95)

MUS_labels = generate_label_df(MUS_tukey, "Volume_uL")#generate labels using function

names(MUS_labels) = c('Letters','Volume_uL')#rename columns for merging

MUS_yvalue = aggregate(Mean_Log2_Raw_Intensity~Volume_uL, data=seerXT_MUS_anova_df, mean)# obtain letter position for y axis using means

MUS_final = merge(MUS_labels,MUS_yvalue) #merge dataframes

MUS_ANOVATukeyHSD_box_plot = ggplot(seerXT_MUS_anova_df, aes(x = reorder(Volume_uL,Volume), y = Mean_Log2_Raw_Intensity)) +
  geom_blank() +
  theme_bw() +
  labs(x = 'Volume (uL)', y = 'Mean Log2 Raw Intensity') +
  ggtitle(expression(atop(bold("Seer Proteograph XT: Murine Sample Volume Experiment"), atop(italic("ANOVA TukeyHSD"), "")))) +
  theme(plot.title = element_text(hjust = 0.5, face='bold')) +
  geom_violin(data = seerXT_MUS_anova_df, aes(x = Volume_uL, y = Mean_Log2_Raw_Intensity, fill = Volume_uL), alpha = 0.4) +
  geom_boxplot(aes(fill = Volume_uL), stat = "boxplot", outlier.shape = NA, alpha = 0.7) +
  geom_text(data = MUS_final, aes(x = Volume_uL, y = Mean_Log2_Raw_Intensity, label = Letters),vjust=-17,hjust=-1) +
  geom_text(data = MUS_final, aes(x = Volume_uL, y = Mean_Log2_Raw_Intensity, label = round(Mean_Log2_Raw_Intensity,2))) +
  scale_fill_viridis(discrete = TRUE) +
  theme(plot.title = element_text(vjust=-0.6))
MUS_ANOVATukeyHSD_box_plot
ggsave("./Plots/MUS_ANOVATukeyHSD_rawLog2Intensity_box_plot.png")
```

\newline

**Figure 5: Combo box/violin plot for the murine sample volume experiment data showing distributions of mean log2 raw intensities (averaged across 3 replicates per sample) separated on the x axis by sample volume. Number displayed on each boxplot is the mean for that intensity distribution. Letters shown at the top display significance categories determined by ANOVA TukeyHSD test (homogeneity of variance assumption is valid, normality assumption is close enough given log2 transformation). PG.Quantity (raw) data used. ANOVA results suggest the 100-250µL distributions are significantly different from the 10-50µL distributions, and the 250µL distribution is significantly different from the 100-125µL distributions.**

```{r MUS_CV}
#Calculate CV per feature
MUS_CV_df = seerXT_MUS_final_2Rep_df %>%
  group_by(Volume,Feature) %>%
  summarise(Mean = mean(Log2_Raw_Intensity, na.rm = TRUE), SD = sd(Log2_Raw_Intensity, na.rm = TRUE), CV = 100*sqrt(2^(log(2)*(SD^2))-1))

#Plot CVs - by volume group
MUS_CV_plot = MUS_CV_df %>%
  ggplot(aes(x = as.factor(Volume), y = CV, fill = as.factor(Volume))) +
  geom_violin(alpha = 0.4) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  labs(title = "Feature CV Distribution by Volume: Murine",
       subtitle = "Outliers are hidden",
       x = "Volume (µL)") +
  theme_bw() +
  scale_fill_viridis(discrete = TRUE) +
  ylim(0, 100) +
  stat_mean_sd_text(y.pos = 90, size = 3, angle=90) +
  #theme(axis.title.x = element_blank()) +
  theme(axis.text.x = element_text(size = 12)) +
  theme(axis.text.y = element_text(size = 12)) +
  theme(axis.title = element_text(size = 14)) +
  theme(title = element_text(size = 14)) +
  theme(legend.position = "none")

ggsave("./Plots/MUS_CV_plot.png", width = 7.29, height = 4.51, units = "in")
MUS_CV_plot
```
\newline

**Figure 6: Feature CV distributions for murine sample volume experiment series, grouped by volume sample. PG.Quantity (raw) data used. No obvious change in CVs with change in sample volume suggests decreasing sample size does not increase technical variability of the Seer Proteograph XT assay.**

```{r MUS_WiT}
#Wilcox test - store pvalue and difference
MUS_seerXT_WiT_df = seerXT_MUS_wide_allV_df %>%
  rowwise() %>%
  mutate(wt_pval_10v25 = wilcox.test(unlist(data_10uL), unlist(data_25uL))$p.value) %>%
  mutate(Diff_10v25 = (median(unlist(data_10uL)) - median(unlist(data_25uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_10v25_BH = p.adjust(wt_pval_10v25, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_10v50 = wilcox.test(unlist(data_10uL), unlist(data_50uL))$p.value) %>%
  mutate(Diff_10v50 = (median(unlist(data_10uL)) - median(unlist(data_50uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_10v50_BH = p.adjust(wt_pval_10v50, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_10v100 = wilcox.test(unlist(data_10uL), unlist(data_100uL))$p.value) %>%
  mutate(Diff_10v100 = (median(unlist(data_10uL)) - median(unlist(data_100uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_10v100_BH = p.adjust(wt_pval_10v100, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_10v125 = wilcox.test(unlist(data_10uL), unlist(data_125uL))$p.value) %>%
  mutate(Diff_10v125 = (median(unlist(data_10uL)) - median(unlist(data_125uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_10v125_BH = p.adjust(wt_pval_10v125, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_10v250 = wilcox.test(unlist(data_10uL), unlist(data_250uL))$p.value) %>%
  mutate(Diff_10v250 = (median(unlist(data_10uL)) - median(unlist(data_250uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_10v250_BH = p.adjust(wt_pval_10v250, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_25v50 = wilcox.test(unlist(data_25uL), unlist(data_50uL))$p.value) %>%
  mutate(Diff_25v50 = (median(unlist(data_25uL)) - median(unlist(data_50uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_25v50_BH = p.adjust(wt_pval_25v50, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_25v100 = wilcox.test(unlist(data_25uL), unlist(data_100uL))$p.value) %>%
  mutate(Diff_25v100 = (median(unlist(data_25uL)) - median(unlist(data_100uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_25v100_BH = p.adjust(wt_pval_25v100, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_25v125 = wilcox.test(unlist(data_25uL), unlist(data_125uL))$p.value) %>%
  mutate(Diff_25v125 = (median(unlist(data_25uL)) - median(unlist(data_125uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_25v125_BH = p.adjust(wt_pval_25v125, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_25v250 = wilcox.test(unlist(data_25uL), unlist(data_250uL))$p.value) %>%
  mutate(Diff_25v250 = (median(unlist(data_25uL)) - median(unlist(data_250uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_25v250_BH = p.adjust(wt_pval_25v250, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_50v100 = wilcox.test(unlist(data_50uL), unlist(data_100uL))$p.value) %>%
  mutate(Diff_50v100 = (median(unlist(data_50uL)) - median(unlist(data_100uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_50v100_BH = p.adjust(wt_pval_50v100, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_50v125 = wilcox.test(unlist(data_50uL), unlist(data_125uL))$p.value) %>%
  mutate(Diff_50v125 = (median(unlist(data_50uL)) - median(unlist(data_125uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_50v125_BH = p.adjust(wt_pval_50v125, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_50v250 = wilcox.test(unlist(data_50uL), unlist(data_250uL))$p.value) %>%
  mutate(Diff_50v250 = (median(unlist(data_50uL)) - median(unlist(data_250uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_50v250_BH = p.adjust(wt_pval_50v250, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_100v125 = wilcox.test(unlist(data_100uL), unlist(data_125uL))$p.value) %>%
  mutate(Diff_100v125 = (median(unlist(data_100uL)) - median(unlist(data_125uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_100v125_BH = p.adjust(wt_pval_100v125, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_100v250 = wilcox.test(unlist(data_100uL), unlist(data_250uL))$p.value) %>%
  mutate(Diff_100v250 = (median(unlist(data_100uL)) - median(unlist(data_250uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_100v250_BH = p.adjust(wt_pval_100v250, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_125v250 = wilcox.test(unlist(data_125uL), unlist(data_250uL))$p.value) %>%
  mutate(Diff_125v250 = (median(unlist(data_125uL)) - median(unlist(data_250uL)))) %>%
  ungroup() %>%
  mutate(wt_pval_125v250_BH = p.adjust(wt_pval_125v250, method = "BH"))

#Add significance flags to WiT df
MUS_seerXT_WiT_df = MUS_seerXT_WiT_df %>%
  mutate(p_val_10v25_sig = ifelse(wt_pval_10v25_BH < 0.05, "Significant", "Non"),
         proteins_10v25_sig = ifelse(wt_pval_10v25_BH < 0.05, Protein.Ids, ""),
         p_val_10v50_sig = ifelse(wt_pval_10v50_BH < 0.05, "Significant", "Non"),
         proteins_10v50_sig = ifelse(wt_pval_10v50_BH < 0.05, Protein.Ids, ""),
         p_val_10v100_sig = ifelse(wt_pval_10v100_BH < 0.05, "Significant", "Non"),
         proteins_10v100_sig = ifelse(wt_pval_10v100_BH < 0.05, Protein.Ids, ""),
         p_val_10v125_sig = ifelse(wt_pval_10v125_BH < 0.05, "Significant", "Non"),
         proteins_10v125_sig = ifelse(wt_pval_10v125_BH < 0.05, Protein.Ids, ""),
         p_val_10v250_sig = ifelse(wt_pval_10v250_BH < 0.05, "Significant", "Non"),
         proteins_10v250_sig = ifelse(wt_pval_10v250_BH < 0.05, Protein.Ids, ""),
         p_val_25v50_sig = ifelse(wt_pval_25v50_BH < 0.05, "Significant", "Non"),
         proteins_25v50_sig = ifelse(wt_pval_25v50_BH < 0.05, Protein.Ids, ""),
         p_val_25v100_sig = ifelse(wt_pval_25v100_BH < 0.05, "Significant", "Non"),
         proteins_25v100_sig = ifelse(wt_pval_25v100_BH < 0.05, Protein.Ids, ""),
         p_val_25v125_sig = ifelse(wt_pval_25v125_BH < 0.05, "Significant", "Non"),
         proteins_25v125_sig = ifelse(wt_pval_25v125_BH < 0.05, Protein.Ids, ""),
         p_val_25v250_sig = ifelse(wt_pval_25v250_BH < 0.05, "Significant", "Non"),
         proteins_25v250_sig = ifelse(wt_pval_25v250_BH < 0.05, Protein.Ids, ""),
         p_val_50v100_sig = ifelse(wt_pval_50v100_BH < 0.05, "Significant", "Non"),
         proteins_50v100_sig = ifelse(wt_pval_50v100_BH < 0.05, Protein.Ids, ""),
         p_val_50v125_sig = ifelse(wt_pval_50v125_BH < 0.05, "Significant", "Non"),
         proteins_50v125_sig = ifelse(wt_pval_50v125_BH < 0.05, Protein.Ids, ""),
         p_val_50v250_sig = ifelse(wt_pval_50v250_BH < 0.05, "Significant", "Non"),
         proteins_50v250_sig = ifelse(wt_pval_50v250_BH < 0.05, Protein.Ids, ""),
         p_val_100v125_sig = ifelse(wt_pval_100v125_BH < 0.05, "Significant", "Non"),
         proteins_100v125_sig = ifelse(wt_pval_100v125_BH < 0.05, Protein.Ids, ""),
         p_val_100v250_sig = ifelse(wt_pval_100v250_BH < 0.05, "Significant", "Non"),
         proteins_100v250_sig = ifelse(wt_pval_100v250_BH < 0.05, Protein.Ids, ""),
         p_val_125v250_sig = ifelse(wt_pval_125v250_BH < 0.05, "Significant", "Non"),
         proteins_125v250_sig = ifelse(wt_pval_125v250_BH < 0.05, Protein.Ids, ""),
  )
```

```{r Plot_MUS_boxplot}
#Organize FC in long format
WiT_boxDS_MUS_df = MUS_seerXT_WiT_df %>% 
                   pivot_longer(names_to = "Dilution_Comparison",
                                values_to = "FC",
                                cols = starts_with("Diff")) %>%
                    mutate(Dilution_Comparison = ifelse(Dilution_Comparison == "Diff_10v25",
                                                        "10uL-25uL",
                                                        ifelse(Dilution_Comparison == "Diff_10v50",
                                                               "10uL-50uL",
                                                               ifelse(Dilution_Comparison == "Diff_10v100",
                                                                      "10uL-100uL",
                                                                      ifelse(Dilution_Comparison == "Diff_10v125",
                                                                             "10uL-125uL",
                                                                             ifelse(Dilution_Comparison == "Diff_10v250",
                                                                                    "10uL-250uL",
                                                                                    ifelse(Dilution_Comparison == "Diff_25v50",
                                                                                           "25uL-50uL",
                                                                                           ifelse(Dilution_Comparison == "Diff_25v100",
                                                                                                  "25uL-100uL",
                                                                                                  ifelse(Dilution_Comparison == "Diff_25v125",
                                                                                                         "25uL-125uL",
                                                                                                         ifelse(Dilution_Comparison == "Diff_25v250",
                                                                                                                "25uL-250uL",
                                                                                                                ifelse(Dilution_Comparison == "Diff_50v100",
                                                                                                                       "50uL-100uL",
                                                                                                                       ifelse(Dilution_Comparison == "Diff_50v125",
                                                                                                                              "50uL-125uL",
                                                                                                                              ifelse(Dilution_Comparison == "Diff_50v250",
                                                                                                                                     "50uL-250uL",
                                                                                                                                     ifelse(Dilution_Comparison == "Diff_100v125",
                                                                                                                                            "100uL-125uL",
                                                                                                                                            ifelse(Dilution_Comparison == "Diff_100v250",
                                                                                                                                                   "100uL-250uL",
                                                                                                                                                   ifelse(Dilution_Comparison == "Diff_125v250",
                                                                                                                                                          "125uL-250uL",
                                                                                                                                                          NA)))))))))))))))) %>%
                    mutate(Dilution_Comparison_Order = ifelse(Dilution_Comparison == "10uL-25uL",
                                                        1,
                                                        ifelse(Dilution_Comparison == "10uL-50uL",
                                                               2,
                                                               ifelse(Dilution_Comparison == "10uL-100uL",
                                                                      3,
                                                                      ifelse(Dilution_Comparison == "10uL-125uL",
                                                                             4,
                                                                             ifelse(Dilution_Comparison == "10uL-250uL",
                                                                                    5,
                                                                                    ifelse(Dilution_Comparison == "25uL-50uL",
                                                                                           6,
                                                                                           ifelse(Dilution_Comparison == "25uL-100uL",
                                                                                                  7,
                                                                                                  ifelse(Dilution_Comparison == "25uL-125uL",
                                                                                                         8,
                                                                                                         ifelse(Dilution_Comparison == "25uL-250uL",
                                                                                                                9,
                                                                                                                ifelse(Dilution_Comparison == "50uL-100uL",
                                                                                                                       10,
                                                                                                                       ifelse(Dilution_Comparison == "50uL-125uL",
                                                                                                                              11,
                                                                                                                              ifelse(Dilution_Comparison == "50uL-250uL",
                                                                                                                                     12,
                                                                                                                                     ifelse(Dilution_Comparison == "100uL-125uL",
                                                                                                                                            13,
                                                                                                                                            ifelse(Dilution_Comparison == "100uL-250uL",
                                                                                                                                                   14,
                                                                                                                                                   ifelse(Dilution_Comparison == "125uL-250uL",
                                                                                                                                                          15,
                                                                                                                                                          NA))))))))))))))))

#Make stat df for labels
MUS_FCstats_df = WiT_boxDS_MUS_df %>% group_by(Dilution_Comparison) %>%
                                      summarise(Median_FC = median(FC))
                                      

#Boxplot of intensity distributions per sample - mouse
WiT_boxDS_MUS_plot = WiT_boxDS_MUS_df %>%
  ggplot(aes(x = reorder(Dilution_Comparison,Dilution_Comparison_Order), y = FC, fill = Dilution_Comparison)) +
  geom_violin(alpha = 0.4) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  # geom_text(data = MUS_final, aes(x = Volume_uL, y = Mean_Log2_Raw_Intensity, label = round(Mean_Log2_Raw_Intensity,2))) +
  geom_text(data = MUS_FCstats_df, aes(x = Dilution_Comparison, y = 8, label = round(Median_FC,2)), position = position_dodge(width=0.9),vjust = -0.5, size = 3) +
  labs(title = "FC Distribution: Mouse Sample Volume Experiment",
       subtitle = "Medians shown at top of each distribution",
       y = "Log2(FC)") +
  theme_bw() +
  #stat_mean_sd_text(size = 2, y.pos = 6000) +
  ylim(-10,10) +
  geom_hline(yintercept=0, colour="grey3", linetype = "dashed") +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12, angle = 90)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14)) +
  #stat_median_iqr_text(y.pos = 7.5, size = 3, angle=90) +
  scale_fill_viridis(discrete = TRUE)
ggsave("./Plots/WiT_boxDS_MUS_Log2RawIntensity_plot.png", width = 4, height = 3, units = "in")
WiT_boxDS_MUS_plot
```

\newline

**Figure 7: Boxplot FC distributions of murine sample volume experiment series data. Numbers at the top of each distribution represent median values. PG.Quantity (raw) data used. Due to experimental design of sample prep/NP incubation, FC distributions are not expected to be exactly on target for the expected dilution FC. No extreme outliers are observed in FC distribution trend across all comparisons, and distribution IQRs widen with increased difference between the sample volumes being compared.**

```{r Plot_WiT_pval_MUS, fig.width=10, fig.height=20}
#Plot WiT pvalue distribution - before multiple testing correction x axis = Wilcox Test Raw P-value, y axis = Aptamer Count
WiT_pval_10v25_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_10v25)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "10uL vs. 25uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_10v25_dist_mouse_plot.png")

WiT_pval_10v50_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_10v50)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "10uL vs. 50uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_10v50_dist_mouse_plot.png")

WiT_pval_10v100_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_10v100)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "10uL vs. 100uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_10v100_dist_mouse_plot.png")

WiT_pval_10v125_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_10v125)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "10uL vs. 125uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_10v125_dist_mouse_plot.png")

WiT_pval_10v250_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_10v250)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "10uL vs. 250uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_10v250_dist_mouse_plot.png")

WiT_pval_25v50_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_25v50)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "25uL vs. 50uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_25v50_dist_mouse_plot.png")

WiT_pval_25v100_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_25v100)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "25uL vs. 100uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_25v100_dist_mouse_plot.png")

WiT_pval_25v125_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_25v125)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "25uL vs. 125uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_25v125_dist_mouse_plot.png")

WiT_pval_25v250_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_25v250)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "25uL vs. 250uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_25v250_dist_mouse_plot.png")

WiT_pval_50v100_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_50v100)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "50uL vs. 100uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_50v100_dist_mouse_plot.png")

WiT_pval_50v125_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_50v125)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "50uL vs. 125uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_50v125_dist_mouse_plot.png")

WiT_pval_50v250_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_50v250)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "50uL vs. 250uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_50v250_dist_mouse_plot.png")

WiT_pval_100v125_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_100v125)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "100uL vs. 125uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_100v125_dist_mouse_plot.png")

WiT_pval_100v250_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_100v250)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "100uL vs. 250uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_100v250_dist_mouse_plot.png")

WiT_pval_125v250_dist_mouse_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(wt_pval_125v250)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "125uL vs. 250uL") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_125v250_dist_mouse_plot.png")

fig_pval_MUS = ggarrange(WiT_pval_10v25_dist_mouse_plot, WiT_pval_10v50_dist_mouse_plot, WiT_pval_10v100_dist_mouse_plot, WiT_pval_10v125_dist_mouse_plot, WiT_pval_10v250_dist_mouse_plot,
                          WiT_pval_25v50_dist_mouse_plot, WiT_pval_25v100_dist_mouse_plot, WiT_pval_25v125_dist_mouse_plot, WiT_pval_25v250_dist_mouse_plot,
                          WiT_pval_50v100_dist_mouse_plot, WiT_pval_50v125_dist_mouse_plot, WiT_pval_50v250_dist_mouse_plot,
                          WiT_pval_100v125_dist_mouse_plot, WiT_pval_100v250_dist_mouse_plot,
                          WiT_pval_125v250_dist_mouse_plot,
                          labels="AUTO", ncol = 3, nrow = 5)
annotate_figure(fig_pval_MUS, top = text_grob("P-Value Distribution of Wilcox Test Results: Mouse", size = 14))
ggsave("./Plots/fig_pval_MUS_Log2RawIntensity.png", width = 8, height = 16)
```

\newline

**Figure 8: P-value distributions for Wilcox tests performed on the mouse dilution series. Log2-transformed data, FC = (low volume - high volume). PG.Quantity (raw) data used. On the feature level, no concerns with performing subsequent Wilcox test comparisons. 100-125µL comparison is likely seeing less-significant results due to close similarity in volume/FC.**

```{r Plot_WiT_volc_MUS, fig.width=20, fig.height=40}
#Wilcox volcano Plot
WiT_10v25_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_10v25, y = -log(wt_pval_10v25_BH, 10), group = p_val_10v25_sig)) +
  geom_point(aes(color = p_val_10v25_sig, text = proteins_10v25_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_10v25_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "-log10(p-value)",
       subtitle = "10uL vs. 25uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_10v25_mouse_volcano_plot.png")
# WiT_10v25_mouse_volcano_plot

# WiT_10v25_mouse_volcano_plotly = ggplotly(WiT_10v25_mouse_volcano_plot, tooltip = "proteins_10v50_sig")
# saveWidget(WiT_10v25_mouse_volcano_plotly, "./Plots/WiT_10v25_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_10v50_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_10v50, y = -log(wt_pval_10v50_BH, 10), group = p_val_10v50_sig)) +
  geom_point(aes(color = p_val_10v50_sig, text = proteins_10v50_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_10v50_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "10uL vs. 50uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_10v50_mouse_volcano_plot.png")
# WiT_10v50_mouse_volcano_plot

# WiT_10v50_mouse_volcano_plotly = ggplotly(WiT_10v50_mouse_volcano_plot, tooltip = "proteins_10v50_sig")
# saveWidget(WiT_10v50_mouse_volcano_plotly, "WiT_10v50_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_10v100_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_10v100, y = -log(wt_pval_10v100_BH, 10), group = p_val_10v100_sig)) +
  geom_point(aes(color = p_val_10v100_sig, text = proteins_10v100_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_10v100_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "10uL vs. 100uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_10v100_mouse_volcano_plot.png")
# WiT_10v100_mouse_volcano_plot

# WiT_10v100_mouse_volcano_plotly = ggplotly(WiT_10v100_mouse_volcano_plot, tooltip = "proteins_10v100_sig")
# saveWidget(WiT_10v100_mouse_volcano_plotly, "WiT_10v100_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_10v125_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_10v125, y = -log(wt_pval_10v125_BH, 10), group = p_val_10v125_sig)) +
  geom_point(aes(color = p_val_10v125_sig, text = proteins_10v125_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_10v125_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "-log10(p-value)",
       subtitle = "10uL vs. 125uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_10v125_mouse_volcano_plot.png")
# WiT_10v125_mouse_volcano_plot

# WiT_10v125_mouse_volcano_plotly = ggplotly(WiT_10v125_mouse_volcano_plot, tooltip = "proteins_10v125_sig")
# saveWidget(WiT_10v125_mouse_volcano_plotly, "WiT_10v125_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_10v250_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_10v250, y = -log(wt_pval_10v250_BH, 10), group = p_val_10v250_sig)) +
  geom_point(aes(color = p_val_10v250_sig, text = proteins_10v250_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_10v250_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "10uL vs. 250uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_10v250_mouse_volcano_plot.png")
# WiT_10v250_mouse_volcano_plot

# WiT_10v250_mouse_volcano_plotly = ggplotly(WiT_10v250_mouse_volcano_plot, tooltip = "proteins_10v250_sig")
# saveWidget(WiT_10v250_mouse_volcano_plotly, "WiT_10v250_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_25v50_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_25v50, y = -log(wt_pval_25v50_BH, 10), group = p_val_25v50_sig)) +
  geom_point(aes(color = p_val_25v50_sig, text = proteins_25v50_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_25v50_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "25uL vs. 50uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_25v50_mouse_volcano_plot.png")
# WiT_25v50_mouse_volcano_plot

# WiT_25v50_mouse_volcano_plotly = ggplotly(WiT_25v50_mouse_volcano_plot, tooltip = "proteins_25v50_sig")
# saveWidget(WiT_25v50_mouse_volcano_plotly, "WiT_25v50_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_25v100_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_25v100, y = -log(wt_pval_25v100_BH, 10), group = p_val_25v100_sig)) +
  geom_point(aes(color = p_val_25v100_sig, text = proteins_25v100_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_25v100_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "-log10(p-value)",
       subtitle = "25uL vs. 100uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_25v100_mouse_volcano_plot.png")
# WiT_25v100_mouse_volcano_plot

# WiT_25v100_mouse_volcano_plotly = ggplotly(WiT_25v100_mouse_volcano_plot, tooltip = "proteins_25v100_sig")
# saveWidget(WiT_25v100_mouse_volcano_plotly, "WiT_25v100_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_25v125_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_25v125, y = -log(wt_pval_25v125_BH, 10), group = p_val_25v125_sig)) +
  geom_point(aes(color = p_val_25v125_sig, text = proteins_25v125_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_25v125_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "25uL vs. 125uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_25v125_mouse_volcano_plot.png")
# WiT_25v125_mouse_volcano_plot

# WiT_25v125_mouse_volcano_plotly = ggplotly(WiT_25v125_mouse_volcano_plot, tooltip = "proteins_25v125_sig")
# saveWidget(WiT_25v125_mouse_volcano_plotly, "WiT_25v125_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_25v250_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_25v250, y = -log(wt_pval_25v250_BH, 10), group = p_val_25v250_sig)) +
  geom_point(aes(color = p_val_25v250_sig, text = proteins_25v250_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_25v250_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "25uL vs. 250uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_25v250_mouse_volcano_plot.png")
# WiT_25v250_mouse_volcano_plot

# WiT_25v250_mouse_volcano_plotly = ggplotly(WiT_25v250_mouse_volcano_plot, tooltip = "proteins_25v250_sig")
# saveWidget(WiT_25v250_mouse_volcano_plotly, "WiT_25v250_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_50v100_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_50v100, y = -log(wt_pval_50v100_BH, 10), group = p_val_50v100_sig)) +
  geom_point(aes(color = p_val_50v100_sig, text = proteins_50v100_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_50v100_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "-log10(p-value)",
       subtitle = "50uL vs. 100uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_50v100_mouse_volcano_plot.png")
# WiT_50v100_mouse_volcano_plot

# WiT_50v100_mouse_volcano_plotly = ggplotly(WiT_50v100_mouse_volcano_plot, tooltip = "proteins_50v100_sig")
# saveWidget(WiT_50v100_mouse_volcano_plotly, "WiT_50v100_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_50v125_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_50v125, y = -log(wt_pval_50v125_BH, 10), group = p_val_50v125_sig)) +
  geom_point(aes(color = p_val_50v125_sig, text = proteins_50v125_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_50v125_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "50uL vs. 125uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_50v125_mouse_volcano_plot.png")
# WiT_50v125_mouse_volcano_plot

# WiT_50v125_mouse_volcano_plotly = ggplotly(WiT_50v125_mouse_volcano_plot, tooltip = "proteins_50v125_sig")
# saveWidget(WiT_50v125_mouse_volcano_plotly, "WiT_50v125_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_50v250_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_50v250, y = -log(wt_pval_50v250_BH, 10), group = p_val_50v250_sig)) +
  geom_point(aes(color = p_val_50v250_sig, text = proteins_50v250_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_50v250_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "50uL vs. 250uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_50v250_mouse_volcano_plot.png")
# WiT_50v250_mouse_volcano_plot

# WiT_50v250_mouse_volcano_plotly = ggplotly(WiT_50v250_mouse_volcano_plot, tooltip = "proteins_50v250_sig")
# saveWidget(WiT_50v250_mouse_volcano_plotly, "WiT_50v250_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_100v125_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_100v125, y = -log(wt_pval_100v125_BH, 10), group = p_val_100v125_sig)) +
  geom_point(aes(color = p_val_100v125_sig, text = proteins_100v125_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_100v125_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "-log10(p-value)",
       subtitle = "100uL vs. 125uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_100v125_mouse_volcano_plot.png")
# WiT_100v125_mouse_volcano_plot

# WiT_100v125_mouse_volcano_plotly = ggplotly(WiT_100v125_mouse_volcano_plot, tooltip = "proteins_100v125_sig")
# saveWidget(WiT_100v125_mouse_volcano_plotly, "WiT_100v125_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_100v250_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_100v250, y = -log(wt_pval_100v250_BH, 10), group = p_val_100v250_sig)) +
  geom_point(aes(color = p_val_100v250_sig, text = proteins_100v250_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_100v250_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "100uL vs. 250uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_100v250_mouse_volcano_plot.png")
# WiT_100v250_mouse_volcano_plot

# WiT_100v250_mouse_volcano_plotly = ggplotly(WiT_100v250_mouse_volcano_plot, tooltip = "proteins_100v250_sig")
# saveWidget(WiT_100v250_mouse_volcano_plotly, "WiT_100v250_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_125v250_mouse_volcano_plot = MUS_seerXT_WiT_df %>%
  ggplot(aes(x = Diff_125v250, y = -log(wt_pval_125v250_BH, 10), group = p_val_125v250_sig)) +
  geom_point(aes(color = p_val_125v250_sig, text = proteins_125v250_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_125v250_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "125uL vs. 250uL") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_125v250_mouse_volcano_plot.png")
# WiT_125v250_mouse_volcano_plot

# WiT_125v250_mouse_volcano_plotly = ggplotly(WiT_125v250_mouse_volcano_plot, tooltip = "proteins_125v250_sig")
# saveWidget(WiT_125v250_mouse_volcano_plotly, "WiT_125v250_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

fig_WiT_MUS = ggarrange(WiT_10v25_mouse_volcano_plot, WiT_10v50_mouse_volcano_plot, WiT_10v100_mouse_volcano_plot, WiT_10v125_mouse_volcano_plot, WiT_10v250_mouse_volcano_plot,
                        WiT_25v50_mouse_volcano_plot, WiT_25v100_mouse_volcano_plot, WiT_25v125_mouse_volcano_plot, WiT_25v250_mouse_volcano_plot,
                        WiT_50v100_mouse_volcano_plot, WiT_50v125_mouse_volcano_plot, WiT_50v250_mouse_volcano_plot,
                        WiT_100v125_mouse_volcano_plot, WiT_100v250_mouse_volcano_plot,
                        WiT_125v250_mouse_volcano_plot,
                        ncol = 3, nrow = 5)
annotate_figure(fig_WiT_MUS, top = text_grob("Seer Proteograph XT Murine DE: Sample Volume Experiment", size = 18))
ggsave("./Plots/fig_WiT_MUS_Log2RawIntensity.png", width = 8, height = 16, units = "in")
```

\newline

**Figure 9: Volcano plots showing significantly differentially expressed proteins between mouse samples in sample volume experiment. Log2-transformed data, FC = (low volume - high volume). PG.Quantity (raw) data used. No features found to be significantly different between any sample volume comparisons.**

```{r MUS_Volume_Features, include = FALSE}
#Figure out which features are only present in high volume samples - after sparsity filter (2Rep min/sample)
# MUS_volfeat_df = seerXT_MUS_final_2Rep_df %>%
#                   dplyr::select(c("Feature","Protein.Ids",
#                                   "Volume","Replicate","NP",
#                                   "Log2_LFQ_Intensity")) %>%
#                   group_by(Feature,Volume) %>%
#                   mutate(Mean_Log2_LFQ_Intensity = mean(Log2_LFQ_Intensity, na.rm = TRUE)) %>%
#                   dplyr::select(-c("Replicate","Log2_LFQ_Intensity")) %>%
#                   unique()

```

### PC3 Protein and Peptide Counts

```{r PC3_Load_Data}
#Load each PC3 file
raw_data_PC3_Gen1 = read.delim("~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/PC3_Gen1_SpLib/report.tsv")
raw_data_PC3_XT_SpLib = read.delim("~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/PC3_XT_SpLib/report.tsv")
raw_data_PC3_XT_libfree = read.delim("~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/PC3_XT_libfree/report.tsv")
raw_data_PC3_XT_timsLib = read.delim("~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/PC3_XT_timsLib/report.tsv")
#Combine all raw files, keeping library as a new column
raw_data_PC3_Gen1 = raw_data_PC3_Gen1 %>% mutate(Search_Method = "SpLib")
raw_data_PC3_XT_SpLib = raw_data_PC3_XT_SpLib %>% mutate(Search_Method = "SpLib")
raw_data_PC3_XT_libfree = raw_data_PC3_XT_libfree %>% mutate(Search_Method = "LibFree")
raw_data_PC3_XT_timsLib = raw_data_PC3_XT_timsLib %>% mutate(Search_Method = "timsLib")
raw_data_PC3 = rbind(raw_data_PC3_Gen1,raw_data_PC3_XT_SpLib,raw_data_PC3_XT_libfree,raw_data_PC3_XT_timsLib)
```

```{r PC3_Organize_Data}
#PC3 - DIANN raw data processing
diann_PC3_subset = raw_data_PC3 %>%
                    #Filter out peptides with Precursor and Protein Group intensities of 0
                    filter(Precursor.Quantity > 0) %>%
                    filter(PG.Quantity > 0) %>%
                    #Filter our any peptides & protein groups that have a Q value of > 0.01 (FDR 1%)
                    filter(Global.PG.Q.Value < 0.01) %>%
                    filter(Global.Q.Value < 0.01) %>%
                    filter(Q.Value < 0.01)

#PC3 - Make new Sample, NP, replicate columns in data df with grep/substring
diann_PC3_subset = diann_PC3_subset %>%
                   mutate(Sample = ifelse(grepl("Old_Kit",Run),
                                          sub("[0-9]*_(.*)_NP[0-9].*","\\1",Run),
                                          sub("^[0-9]*_(.*)([A-Z])_NP.*","\\1",Run)),
                           NP = sub("[0-9]*_.*_NP(.).*","\\1",Run),
                           Replicate = ifelse(grepl("Old_Kit",Run),
                                              "A",
                                              sub("^[0-9]*_.*([A-Z])_NP.*","\\1",Run)),
                           Sample = paste(sub("neat","XT",Sample),Search_Method,Replicate,sep = "_"))

#PC3 - Convert output to summarized protein info by removing duplicate peptides
PC3_proteins = diann_PC3_subset %>%
                group_by(Run, Protein.Group, PG.Quantity, PG.Normalised, PG.MaxLFQ, PG.Q.Value) %>%
                distinct(Run, Protein.Group, PG.Quantity, PG.Normalised, PG.MaxLFQ, PG.Q.Value, .keep_all = TRUE) %>%
                ungroup() %>%
                mutate(Log2_LFQ_Intensity = ifelse(PG.MaxLFQ == 0, NA, log2(PG.MaxLFQ))) %>%
                filter(!is.na(Log2_LFQ_Intensity))

# Save protein data table - no sparsity filter (no replicates)
write.table(PC3_proteins, "~/Code/XT_Comparison/20240207_Murine_Liver_Expl_Plasma/Data/SeerXT_PC3all_proteins.tsv", sep = "\t", row.names = FALSE)
```

**Table 4: Peptide and protein counts for PC3 samples in Seer Proteograph method comparison study (Gen 1, XT SpLib, XT timsLib, XT libfree). PG.MaxLFQ (normalized) data used.**

```{r PC3_Num_Table}
#Create df for protein count table
PC3_protnum_df = PC3_proteins %>% dplyr::select(c("Sample","Protein.Ids")) %>%
                                   unique() %>%
                                   dplyr::group_by(Sample) %>%
                                   summarise(Protein_Count = n())

#Add peptide-level log2 intensity and NA filter
PC3_peptide_df = diann_PC3_subset %>% 
                  mutate(Log2_LFQ_Intensity = ifelse(PG.MaxLFQ == 0, NA, log2(PG.MaxLFQ))) %>%
                  filter(!is.na(Log2_LFQ_Intensity))

#Create peptide count df
PC3_pepnum_df = PC3_peptide_df %>% dplyr::select(c("Sample","Protein.Ids","Precursor.Id")) %>%
                                   unique() %>%
                                   dplyr::group_by(Sample) %>%
                                   summarise(Peptide_Count = n())

#Find number of proteins in common across all methods
PC3_protnum_allMethod_df = PC3_proteins %>% mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
                                dplyr::group_by(Protein.Ids,Method) %>%
                                summarize(data = list(Log2_LFQ_Intensity), count = n(), .groups = "drop") %>%
                                pivot_wider(names_from = Method, values_from = c(data,count)) %>%
                                filter(count_PC3_Old_Kit_SpLib>=1 & count_PC3_XT_SpLib>=1 & count_PC3_XT_timsLib>=1 & count_PC3_XT_LibFree>=1)

#Combine protein count column with peptide count df for table
PC3_counttable_df = merge(PC3_pepnum_df,PC3_protnum_df,by = "Sample")
PC3_counttable_df["Protein_Count_1RepMinAllMethods"] = length(PC3_protnum_allMethod_df$Protein.Ids)

knitr::kable(PC3_counttable_df)
```

```{r PC3_Protein_Count_Plot}
#Create df for protein bar plot
PC3_protnum_plot_df = PC3_protnum_df %>% mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
                                          group_by(Method) %>%
                                          mutate(Mean_Protein_Count_noSF = round(mean(Protein_Count),0)) %>%
                                          ungroup() %>%
                                          dplyr::select(c("Method","Mean_Protein_Count_noSF")) %>%
                                          unique()

#Bar plot
PC3_protnum_plot = ggplot(PC3_protnum_plot_df, aes(fill=Method, y=Mean_Protein_Count_noSF, x=Method)) + 
  geom_bar(position = "dodge",stat="identity") + 
  geom_text(aes(y = Mean_Protein_Count_noSF + 100, label = Mean_Protein_Count_noSF)) +
  theme_bw() +
  labs(x = "Method",
       y = "Protein Count",
       title = "Seer Proteograph XT Comparison: PC3 Protein Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/PC3_protnum_plot.png")
PC3_protnum_plot
```
\newline
 
**Figure 10: Protein counts for PC3 samples across Proteograph and search method conditions. PG.MaxLFQ (normalized) data used. Gen1 has the highest protien count, followed by XT_SpLib. XT_LibFree and XT_timsLib have slightly lower counts.**

```{r PC3_ProteinVenn_Plot}
#Create Venn diagram for protein counts - Gen 1 vs XT (SpLib)
PC3_protvenn_df = PC3_proteins %>% mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
                                   filter(Method == "PC3_Old_Kit_SpLib" | Method == "PC3_XT_SpLib") %>%
                                   dplyr::select(c("Method","Protein.Ids")) %>%
                                   unique() %>%
                                   pivot_wider(names_from = Method, values_from = Protein.Ids)

PC3_protvenn_list = list(PC3_Old_Kit_SpLib = unlist(PC3_protvenn_df$PC3_Old_Kit_SpLib[1]),
                         PC3_XT_SpLib = unlist(PC3_protvenn_df$PC3_XT_SpLib[1]))
PC3_protvenn_plot = ggVennDiagram(PC3_protvenn_list, color = "black", lwd = 0.8, lty = 1,
                                  category.names = c("G1","XT")) +
                        scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
                        labs(title = "Seer Proteograph Comparison: Gen 1 vs. XT SpLib") +
                        theme(legend.position = "none")
ggsave("~/Code/XT_Comparison/Plots/PC3_protvenn_plot.png")
PC3_protvenn_plot
```
\newline

**Figure 11: Venn diagram showing protein overlap between Gen 1 (G1) and XT Seer Proteograph results (SpLib-searched data).**

```{r PC3_Peptide_Count_Plot}
#Create df for peptide bar plot
PC3_pepnum_plot_df = PC3_pepnum_df %>% mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
                                          group_by(Method) %>%
                                          mutate(Mean_Peptide_Count_noSF = round(mean(Peptide_Count),0)) %>%
                                          ungroup() %>%
                                          dplyr::select(c("Method","Mean_Peptide_Count_noSF")) %>%
                                          unique()

#Bar plot
PC3_pepnum_plot = ggplot(PC3_pepnum_plot_df, aes(fill=Method, y=Mean_Peptide_Count_noSF, x=Method)) + 
  geom_bar(position = "dodge",stat="identity") + 
  geom_text(aes(y = Mean_Peptide_Count_noSF + 2000, label = Mean_Peptide_Count_noSF)) +
  theme_bw() +
  labs(x = "Method",
       y = "Peptide Count",
       title = "Seer Proteograph XT Comparison: PC3 Peptide Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE) +
  ylim(0,30000)
ggsave("~/Code/XT_Comparison/Plots/PC3_pepnum_plot.png")
PC3_pepnum_plot
```
\newline
 
**Figure 12: Peptide counts for PC3 samples across Proteograph and search method conditions. PG.MaxLFQ (normalized) data used. Gen1 and XT_SpLib have similar higher peptide counts compared to XT_LibFree and XT_timsLib. XT_timsLib has slightly higher peptide count than XT_LibFree.**

```{r PC3_PeptideVenn_Plot}
#Create Venn diagram for protein counts - Gen 1 vs XT (SpLib)
PC3_pepvenn_df = PC3_peptide_df %>% mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
                                    mutate(Protein_Peptide = paste(Protein.Ids, Precursor.Id, sep = "_")) %>%
                                   filter(Method == "PC3_Old_Kit_SpLib" | Method == "PC3_XT_SpLib") %>%
                                   dplyr::select(c("Method","Protein_Peptide")) %>%
                                   unique() %>%
                                   pivot_wider(names_from = Method, values_from = Protein_Peptide)

PC3_pepvenn_list = list(PC3_Old_Kit_SpLib = unlist(PC3_pepvenn_df$PC3_Old_Kit_SpLib[1]),
                         PC3_XT_SpLib = unlist(PC3_pepvenn_df$PC3_XT_SpLib[1]))
PC3_pepvenn_plot = ggVennDiagram(PC3_pepvenn_list, color = "black", lwd = 0.8, lty = 1,
                                  category.names = c("G1","XT")) +
                      scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
                      labs(title = "Seer Proteograph Comparison: Gen 1 vs. XT SpLib") +
                      theme(legend.position = "none")
ggsave("~/Code/XT_Comparison/Plots/PC3_pepvenn_plot.png")
PC3_pepvenn_plot
```
\newline

**Figure 13: Venn diagram showing peptide overlap between Gen 1 (G1) and XT Seer Proteograph results (SpLib-searched data).**

### PC3 XT Search Method Comparison

```{r PC3XT_SF}
#No sparsity filter - create features
PC3XT_feature_noSF_df = PC3_proteins %>%
  mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
  filter(!Method == "PC3_Old_Kit_SpLib") %>%
  mutate(Feature = paste(NP, Protein.Ids, sep = "_")) %>%
  group_by(Method,Feature) %>%
  mutate(detection_repcount = n_distinct(Replicate)) %>%
  ungroup() %>%
  filter(detection_repcount >= 1)

#2RepMin sparsity filter - create features
PC3XT_feature_2RepMin_df = PC3_proteins %>%
  mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
  filter(!Method == "PC3_Old_Kit_SpLib") %>%
  mutate(Feature = paste(NP, Protein.Ids, sep = "_")) %>%
  group_by(Method,Feature) %>%
  mutate(detection_repcount = n_distinct(Replicate)) %>%
  ungroup() %>%
  filter(detection_repcount >= 2)
```

```{r PC3_DataTransform}
#Transform data to wide form for statistical test - using noSF data since only 2 replicates
PC3_wide_df = PC3XT_feature_2RepMin_df %>% dplyr::group_by(Feature,Protein.Ids,Method) %>%
                                            summarize(data = list(Log2_LFQ_Intensity), count = n(), .groups = "drop") %>%
                                            pivot_wider(names_from = Method, values_from = c(data,count))

#Filter out any features with <1 intensity count
PC3_wide_allLib_df = PC3_wide_df %>% filter(count_PC3_XT_SpLib>=1 & count_PC3_XT_timsLib>=1 & count_PC3_XT_LibFree>=1)

```

**Table 5: Feature counts for PC3 XT samples in Seer Proteograph method comparison study (SpLib, timsLib, libfree). PG.MaxLFQ (normalized) data used.**

```{r PC3XT_Feature_Num_Table}
#Create df for feature count table
PC3XT_featnum_noSF_df = PC3XT_feature_noSF_df %>% dplyr::group_by(Sample) %>%
                                                    summarise(Feature_Count_noSF = n())

PC3XT_featnum_2Rep_df = PC3XT_feature_2RepMin_df %>% dplyr::group_by(Sample) %>%
                                                    summarise(Feature_Count_2RepMin = n())

PC3XT_featnum_df = merge(PC3XT_featnum_noSF_df,PC3XT_featnum_2Rep_df, by = "Sample")
PC3XT_featnum_df["Feature_Count_1RepMin_AllMethods"] = length(PC3_wide_allLib_df$Feature)

PC3XT_feattable_df = PC3XT_featnum_df
knitr::kable(PC3XT_feattable_df)
```

```{r PC3XT_Feature_Count_Plot}
#Plot noSF protein data similar to peptide bar graph below
PC3XT_featnum_plot_df = PC3XT_featnum_df %>% mutate(Method = sub("(.*)_.$","\\1",Sample)) %>%
                                              group_by(Method) %>%
                                              summarise(Mean_Feature_Count_noSF = round(mean(Feature_Count_noSF),0),
                                                        SD_Feature_Count_noSF = sd(Feature_Count_noSF),
                                                        Mean_Feature_Count_2RepMin = round(mean(Feature_Count_2RepMin),0),
                                                        SD_Feature_Count_2RepMin = sd(Feature_Count_2RepMin)) %>%
                                              pivot_longer(names_to = c(".value","FilterType"),
                                                          names_sep = c("_Feature_Count_"), -c("Method")) %>%
                                              mutate(FilterType = ifelse(FilterType == "noSF",
                                                                  "1RepMin (no filter)",
                                                                  FilterType))
                                                                        
#Bar plot
PC3XT_featnum_plot = ggplot(PC3XT_featnum_plot_df,
                            aes(fill=FilterType, y=Mean, x=Method)) + 
  geom_bar(position = "dodge",stat="identity", alpha = 0.85) + 
  geom_errorbar(aes(ymin=Mean-SD, ymax=Mean+SD), position = position_dodge(0.9), stat = "identity",colour="black", size=0.5, width = 0.4) +
  theme_bw() +
  labs(x = "Method",
       y = "Mean Feature Count",
       title = "Seer Proteograph XT Comparison: PC3 XT Feature Counts",
       subtitle = "") +
  scale_fill_viridis(discrete = TRUE)
ggsave("~/Code/XT_Comparison/Plots/PC3XT_featnum_plot.png")
PC3XT_featnum_plot
```
\newline

**Figure 14: Feature counts for PC3 XT samples across search method conditions. Error bars represent +/- 1 SD from the mean, calculated across replicates. PG.MaxLFQ (normalized) data used. LibFree method results in slightly more features than SpLib or timsLib, but given SD between replicates all are fairly close in feature count.**

```{r PC3XT_ANOVA_P1, include = FALSE}
#Transform data for anova
PC3XT_anova_df = PC3XT_feature_noSF_df %>% dplyr::group_by(Feature,Method) %>%
                                            summarize(Mean_Log2_LFQ_Intensity = mean(Log2_LFQ_Intensity),
                                                      count = n(), .groups = "drop")

#Create linear model for aov() - (yValue ~ xValue)
model = lm(Mean_Log2_LFQ_Intensity ~ Method, data = PC3XT_anova_df)
PC3XT_anova = aov(model)

#ANOVA Assumptions
# 1. Homogeneity of variances - plot and Levene’s test
plot(PC3XT_anova, 1)
leveneTest(Mean_Log2_LFQ_Intensity ~ Method, data = PC3XT_anova_df)
lt_pval = leveneTest(Mean_Log2_LFQ_Intensity ~ Method, data = PC3XT_anova_df)$`Pr(>F)`[1]
# 2. Normality - plot and Shapiro-Wilk or Anderson-Darling test
plot(PC3XT_anova, 2)
PC3XT_anova_residuals = residuals(object = PC3XT_anova)
# shapiro.test(x =PC3XT_anova_residuals) - for smaller sample sizes (<5000)
# sh_pval = shapiro.test(PC3XT_anova_residuals)$p.value
ad.test(PC3XT_anova_residuals)
ad_pval = ad.test(PC3XT_anova_residuals)$p.value
```

```{r PC3XT_ANOVA_P2}
# Tukey test to study each pair of treatment :
PC3XT_tukey = TukeyHSD(PC3XT_anova, which = "Method", conf.level = 0.95)

PC3XT_labels = generate_label_df(PC3XT_tukey, "Method") #generate labels using function

names(PC3XT_labels) = c('Letters','Method')#rename columns for merging

PC3XT_yvalue = aggregate(Mean_Log2_LFQ_Intensity~Method, data=PC3XT_anova_df, mean)# obtain letter position for y axis using means

PC3XT_final = merge(PC3XT_labels,PC3XT_yvalue) #merge dataframes

PC3XT_ANOVATukeyHSD_box_plot = ggplot(PC3XT_anova_df, aes(x = Method, y = Mean_Log2_LFQ_Intensity)) +
  geom_blank() +
  theme_bw() +
  labs(x = 'Method', y = 'Mean Log2 LFQ Intensity') +
  ggtitle(expression(atop(bold("Seer Proteograph XT: PC3 XT Search Method Comparison"), atop(italic("ANOVA TukeyHSD"), "")))) +
  theme(plot.title = element_text(hjust = 0.5, face='bold')) +
  geom_violin(data = PC3XT_anova_df, aes(x = Method, y = Mean_Log2_LFQ_Intensity, fill = Method), alpha = 0.4) +
  geom_boxplot(aes(fill = Method), stat = "boxplot", outlier.shape = NA, alpha = 0.7) +
  geom_text(data = PC3XT_final, aes(x = Method, y = Mean_Log2_LFQ_Intensity, label = Letters),vjust=-17,hjust=-1) +
  geom_text(data = PC3XT_final, aes(x = Method, y = Mean_Log2_LFQ_Intensity, label = round(Mean_Log2_LFQ_Intensity,2))) +
  scale_fill_viridis(discrete = TRUE) +
  theme(plot.title = element_text(vjust=-0.6))
PC3XT_ANOVATukeyHSD_box_plot
ggsave("./Plots/PC3XT_ANOVATukeyHSD_LFQLog2Intensity_box_plot.png")
```

\newline

**Figure 15: Combo box/violin plot for the PC3 XT search method comparison showing distributions of mean log2 LFQ intensities (averaged across 2 replicates per sample) separated on the x axis by search method. Number displayed on each boxplot is the mean for that intensity distribution. Letters shown at the top display significance categories determined by ANOVA TukeyHSD test (note: homogeneity of variance and normality assumptions are statistically invalid, so ANOVA is included here only as a visual aid to suggest possible pairwise differences). PG.MaxLFQ (normalized) data used. ANOVA suggests that the LibFree distribution is significantly different from the other two search methods (SpLib and timsLib).**

```{r PC3XT_CV}
#Calculate CV per feature
PC3XT_CV_df = PC3XT_feature_noSF_df %>%
  group_by(Method,Feature) %>%
  summarise(Mean = mean(Log2_LFQ_Intensity, na.rm = TRUE), SD = sd(Log2_LFQ_Intensity, na.rm = TRUE), CV = 100*sqrt(2^(log(2)*(SD^2))-1))

#Plot CVs - by volume group
PC3XT_CV_plot = PC3XT_CV_df %>%
  ggplot(aes(x = Method, y = CV, fill = Method)) +
  geom_violin(alpha = 0.4) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  labs(title = "Feature CV Distribution by Search Method: PC3 XT",
       subtitle = "Outliers are hidden",
       x = "Method") +
  theme_bw() +
  scale_fill_viridis(discrete = TRUE) +
  ylim(0, 100) +
  stat_mean_sd_text(y.pos = 90, size = 3, angle=90) +
  theme(axis.text.x = element_text(size = 12)) +
  theme(axis.text.y = element_text(size = 12)) +
  theme(axis.title = element_text(size = 14)) +
  theme(title = element_text(size = 14)) +
  theme(legend.position = "none")

ggsave("./Plots/PC3XT_CV_plot.png", width = 7.29, height = 4.51, units = "in")
PC3XT_CV_plot
```
\newline

**Figure 16: Feature CV distributions for PC3 XT search method comparison study, grouped by search method. PG.MaxLFQ (normalized) data used. No obvious change in CVs with change in search method.**

```{r PC3XT_WiT}
#Wilcox test - store pvalue and difference
PC3XT_WiT_df = PC3_wide_allLib_df %>%
  rowwise() %>%
  mutate(wt_pval_SpLibvtimsLib = wilcox.test(unlist(data_PC3_XT_SpLib), unlist(data_PC3_XT_timsLib))$p.value) %>%
  mutate(Diff_SpLibvtimsLib = (median(unlist(data_PC3_XT_SpLib)) - median(unlist(data_PC3_XT_timsLib)))) %>%
  ungroup() %>%
  mutate(wt_pval_SpLibvtimsLib_BH = p.adjust(wt_pval_SpLibvtimsLib, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_SpLibvLibFree = wilcox.test(unlist(data_PC3_XT_SpLib), unlist(data_PC3_XT_LibFree))$p.value) %>%
  mutate(Diff_SpLibvLibFree = (median(unlist(data_PC3_XT_SpLib)) - median(unlist(data_PC3_XT_LibFree)))) %>%
  ungroup() %>%
  mutate(wt_pval_SpLibvLibFree_BH = p.adjust(wt_pval_SpLibvLibFree, method = "BH")) %>%
  rowwise() %>%
  mutate(wt_pval_timsLibvLibFree = wilcox.test(unlist(data_PC3_XT_timsLib), unlist(data_PC3_XT_LibFree))$p.value) %>%
  mutate(Diff_timsLibvLibFree = (median(unlist(data_PC3_XT_timsLib)) - median(unlist(data_PC3_XT_LibFree)))) %>%
  ungroup() %>%
  mutate(wt_pval_timsLibvLibFree_BH = p.adjust(wt_pval_timsLibvLibFree, method = "BH"))

#Add significance flags to WiT df
PC3XT_WiT_df = PC3XT_WiT_df %>%
  mutate(p_val_SpLibvtimsLib_sig = ifelse(wt_pval_SpLibvtimsLib_BH < 0.05, "Significant", "Non"),
         proteins_SpLibvtimsLib_sig = ifelse(wt_pval_SpLibvtimsLib_BH < 0.05, Protein.Ids, ""),
         p_val_SpLibvLibFree_sig = ifelse(wt_pval_SpLibvLibFree_BH < 0.05, "Significant", "Non"),
         proteins_SpLibvLibFree_sig = ifelse(wt_pval_SpLibvLibFree_BH < 0.05, Protein.Ids, ""),
         p_val_timsLibvLibFree_sig = ifelse(wt_pval_timsLibvLibFree_BH < 0.05, "Significant", "Non"),
         proteins_timsLibvLibFree_sig = ifelse(wt_pval_timsLibvLibFree_BH < 0.05, Protein.Ids, "")
        )
```

```{r Plot_PC3XT_boxplot}
#Organize FC in long format
WiT_boxDS_PC3XT_df = PC3XT_WiT_df %>% 
                   pivot_longer(names_to = "Method_Comparison",
                                values_to = "FC",
                                cols = starts_with("Diff")) %>%
                    mutate(Method_Comparison = ifelse(Method_Comparison == "Diff_SpLibvtimsLib",
                                                        "SpLib-timsLib",
                                                        ifelse(Method_Comparison == "Diff_SpLibvLibFree",
                                                               "SpLib-LibFree",
                                                               ifelse(Method_Comparison == "Diff_timsLibvLibFree",
                                                                      "timsLib-LibFree",
                                                                      NA))))
#Make stat df for labels
PC3XT_FCstats_df = WiT_boxDS_PC3XT_df %>% group_by(Method_Comparison) %>%
                                      summarise(Median_FC = median(FC))

#Boxplot of intensity distributions per sample - mouse
WiT_boxDS_PC3XT_plot = WiT_boxDS_PC3XT_df %>%
  ggplot(aes(x = Method_Comparison, y = FC, fill = Method_Comparison)) +
  geom_violin(alpha = 0.4) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  # geom_text(data = MUS_final, aes(x = Volume_uL, y = Mean_Log2_Raw_Intensity, label = round(Mean_Log2_Raw_Intensity,2))) +
  geom_text(data = PC3XT_FCstats_df, aes(x = Method_Comparison, y = 6, label = round(Median_FC,2)), position = position_dodge(width=0.9),vjust = -0.5, size = 3) +
  labs(title = "FC Distribution: PC3 XT Search Method Comparison",
       subtitle = "Medians shown at top of each distribution",
       y = "Log2(FC)") +
  theme_bw() +
  #stat_mean_sd_text(size = 2, y.pos = 6000) +
  ylim(-6,6) +
  geom_hline(yintercept=0, colour="grey3", linetype = "dashed") +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title.x = element_blank()) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14)) +
  scale_fill_viridis(discrete = TRUE)
ggsave("./Plots/WiT_boxDS_PC3XT_Log2LFQIntensity_plot.png", width = 4, height = 3, units = "in")
WiT_boxDS_PC3XT_plot
```
\newline

**Figure 17: Boxplot FC distributions of PC3 XT search method comparison data. Numbers at the top of each distribution represent median values. PG.MaxLFQ (normalized) data used, features must appear in 2 replicates in both search method datasets being compared (no NAs). All comparisons are very similar, as expected. Observed deviations from FC=0 in this plot are likely due to differences in number of peptides detected per protein group (differences at protein rollup stage).**

```{r Plot_WiT_pval_PC3XT, fig.width=8, fig.height=4}
#Plot WiT pvalue distribution - before multiple testing correction x axis = Wilcox Test Raw P-value, y axis = Aptamer Count
WiT_pval_SpLibvtimsLib_dist_plot = PC3XT_WiT_df %>%
  ggplot(aes(wt_pval_SpLibvtimsLib)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "SpLib vs. timsLib") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_SpLibvtimsLib_dist_mouse_plot.png")

WiT_pval_SpLibvLibFree_dist_plot = PC3XT_WiT_df %>%
  ggplot(aes(wt_pval_SpLibvLibFree)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "SpLib vs. LibFree") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_SpLibvLibFree_dist_mouse_plot.png")

WiT_pval_timsLibvLibFree_dist_plot = PC3XT_WiT_df %>%
  ggplot(aes(wt_pval_timsLibvLibFree)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  geom_histogram(breaks = seq(0,1,0.05), fill = "#22c6c9", color = "black", alpha = 0.5) +
  labs(x = "",
       y = "",
       title = "",
       subtitle = "timslib vs. LibFree") +
  theme(plot.subtitle = element_text(face = "italic"))
#ggsave("WiT_pval_timsLibvLibFree_dist_mouse_plot.png")

fig_pval_PC3XT = ggarrange(WiT_pval_SpLibvtimsLib_dist_plot, WiT_pval_SpLibvLibFree_dist_plot, WiT_pval_timsLibvLibFree_dist_plot,
                          labels="AUTO", ncol = 3, nrow = 1)
annotate_figure(fig_pval_PC3XT, top = text_grob("P-Value Distribution of Wilcox Test Results: PC3 XT", size = 14))
ggsave("./Plots/fig_pval_PC3XT_Log2LFQIntensity.png", width = 8, height = 16)
```

\newline

**Figure 18: P-value distributions for Wilcox tests performed on the PC3 XT search method comparison data. Log2-transformed data. PG.MaxLFQ (normalized) data used. Wilcox tests are valid.**

```{r Plot_WiT_volc_PC3XT, fig.width=8, fig.height=4}
#Wilcox volcano Plot
WiT_SpLibvtimsLib_volcano_plot = PC3XT_WiT_df %>%
  ggplot(aes(x = Diff_SpLibvtimsLib, y = -log(wt_pval_SpLibvtimsLib_BH, 10), group = p_val_SpLibvtimsLib_sig)) +
  geom_point(aes(color = p_val_SpLibvtimsLib_sig, text = proteins_SpLibvtimsLib_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_SpLibvtimsLib_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "-log10(p-value)",
       subtitle = "SpLib vs. timsLib") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_SpLibvtimsLib_mouse_volcano_plot.png")
# WiT_SpLibvtimsLib_mouse_volcano_plot

# WiT_SpLibvtimsLib_mouse_volcano_plotly = ggplotly(WiT_SpLibvtimsLib_mouse_volcano_plot, tooltip = "proteins_SpLibvtimsLib_sig")
# saveWidget(WiT_SpLibvtimsLib_mouse_volcano_plotly, "./Plots/WiT_SpLibvtimsLib_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_SpLibvLibFree_volcano_plot = PC3XT_WiT_df %>%
  ggplot(aes(x = Diff_SpLibvLibFree, y = -log(wt_pval_SpLibvLibFree_BH, 10), group = p_val_SpLibvLibFree_sig)) +
  geom_point(aes(color = p_val_SpLibvLibFree_sig, text = proteins_SpLibvLibFree_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_SpLibvLibFree_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "SpLib vs. LibFree") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_SpLibvLibFree_mouse_volcano_plot.png")
# WiT_SpLibvLibFree_mouse_volcano_plot

# WiT_SpLibvLibFree_mouse_volcano_plotly = ggplotly(WiT_SpLibvLibFree_mouse_volcano_plot, tooltip = "proteins_SpLibvLibFree_sig")
# saveWidget(WiT_SpLibvLibFree_mouse_volcano_plotly, "WiT_SpLibvLibFree_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

WiT_timsLibvLibFree_volcano_plot = PC3XT_WiT_df %>%
  ggplot(aes(x = Diff_timsLibvLibFree, y = -log(wt_pval_timsLibvLibFree_BH, 10), group = p_val_timsLibvLibFree_sig)) +
  geom_point(aes(color = p_val_timsLibvLibFree_sig, text = proteins_timsLibvLibFree_sig), size = 2, alpha = 0.5) +
  geom_hline(yintercept = -log(0.05, 10), linetype = "dashed", color = "red") +
  geom_vline(xintercept = 2, color = "red", linetype = "dashed") +
  geom_vline(xintercept = -2, color = "red", linetype = "dashed") +
  geom_text_repel(aes(label = proteins_timsLibvLibFree_sig), max.overlaps = 20) +
  scale_color_manual(values = c("black", "red")) +
  labs(title = "",
       x = "Log2(FC)",
       y = "",
       subtitle = "timsLib vs. LibFree") +
  theme_bw() +
  xlim(-10,10) +
  theme(legend.position = "none") +
  theme(plot.subtitle = element_text(face = "italic")) +
  theme(axis.text.x = element_text(vjust = 0.5, size = 12)) +
  theme(axis.text.y = element_text(vjust = 0.5, size = 12)) +
  theme(axis.title = element_text(vjust = 0.5, size = 14)) +
  theme(title = element_text(size = 14))
#ggsave("WiT_timsLibvLibFree_mouse_volcano_plot.png")
# WiT_timsLibvLibFree_mouse_volcano_plot

# WiT_timsLibvLibFree_mouse_volcano_plotly = ggplotly(WiT_timsLibvLibFree_mouse_volcano_plot, tooltip = "proteins_timsLibvLibFree_sig")
# saveWidget(WiT_timsLibvLibFree_mouse_volcano_plotly, "WiT_timsLibvLibFree_mouse_volcano_plotly.html", selfcontained = F, libdir = "lib")

fig_WiT_PC3XT = ggarrange(WiT_SpLibvtimsLib_volcano_plot, WiT_SpLibvLibFree_volcano_plot, WiT_timsLibvLibFree_volcano_plot,
                        ncol = 3, nrow = 1)
annotate_figure(fig_WiT_PC3XT, top = text_grob("Seer Proteograph XT PC3 DE: Search Method Comparison", size = 18))
ggsave("./Plots/fig_WiT_PC3XT_Log2LFQIntensity.png", width = 8, height = 16, units = "in")
```

\newline

**Figure 19: Volcano plots showing significantly differentially expressed proteins between PC3 XT samples in search method comparison experiment. Log2-transformed data. PG.MaxLFQ (normalized) data used. No significant differences between any of the search method datasets on the feature level.**

